# 2026-02-10 NovaScribe 開發日誌

## 專案：NovaScribe 部落格系統

### 完成項目

#### fix-prisma-init (17/17 完成) ✅
- 安裝 `@prisma/adapter-pg` 和 `pg`
- 修改 `src/lib/prisma.ts` 使用 PrismaPg adapter（Prisma 7 custom output path 強制要求）
- 修正 `src/app/api/admin/comments/stats/route.ts` 的 CommentStatus enum（使用 `DELETED` 取代不存在的 `REJECTED`）
- 驗證所有 API endpoints 正常（login, session, providers, stats）

#### fix-auth-setup (22/22 完成) ✅
- 將 `src/proxy.ts` 還原為 `src/middleware.ts`（Next.js 16 棄用但仍支援）
- 使用 `withAuth` 函式導出 middleware
- 建立 `src/app/(admin)/layout.tsx` 包裹 SessionProvider（覆蓋整個 (admin) route group）
- 驗證後台認證功能正常（未登入重導向、登入後可訪問 /admin）

#### fix-frontend-setup (36/41 部分完成)
**完成項目：**
- 刪除 `src/app/page.tsx`（讓 `(public)/page.tsx` 自動生效）
- 修改 `next.config.ts` 添加 `allowedDevOrigins`（消除 cross origin 警告）
- 建立並執行 `prisma/seed-content.ts`（3 分類、10 標籤、3 文章、3 站點設定）
- 實作 `src/app/(public)/page.tsx` 完整文章列表顯示
- **修正 Prisma import 錯誤**：4 個 service 檔案從 default import 改為 named import
  - `src/lib/services/comment.service.ts`
  - `src/lib/services/public-category.service.ts`
  - `src/lib/services/public-post.service.ts`
  - `src/lib/services/public-tag.service.ts`
- **修正介面不一致**：
  - `CategoryList.tsx`: `_count.posts` → `postCount`
  - `TagCloud.tsx`: `_count.posts` → `postCount`
- 驗證 `/`, `/categories`, `/tags` 正常顯示（200）

**未完成項目（5/41）：**
- 任務 6.2, 6.4, 6.5：動態路由驗證（`/posts`, `/categories/tech`, `/tags/javascript`）
- 任務 7.3, 7.4：文章詳情頁繁體中文檢查

### 阻塞問題（Critical）

#### 1. Next.js 16 Async params Breaking Change
**問題：** Next.js 16 將動態路由的 `params` 改為 Promise，所有動態路由頁面崩潰（500 錯誤）

**錯誤訊息：**
```
Error: Route "/categories/[slug]" used `params.slug`. `params` is a Promise 
and must be unwrapped with `await` or `React.use()` before accessing its properties.
```

**影響檔案：**
- `src/app/(public)/categories/[slug]/page.tsx`
- `src/app/(public)/tags/[slug]/page.tsx`
- `src/app/(public)/posts/[slug]/page.tsx`

**需要修正：**
- `generateMetadata({ params })`: `const { slug } = await params`
- Page component `({ params })`: `const { slug } = await params`

#### 2. Prisma 7 Query Engine Panic
**問題：** Prisma 7 + driver adapter 在動態路由中執行 `findUnique` 時觸發 Rust panic

**錯誤訊息：**
```
PrismaClientRustPanicError: panicked at query-compiler/core/src/query_document/selection.rs:218:51:
called `Option::unwrap()` on a `None` value
```

**影響：**
- 所有使用 `findUnique` 的動態路由查詢
- `getCategoryBySlug`, `getTagBySlug`, `getPostBySlug`

**可能原因：**
- Prisma 7.3.0 + `@prisma/adapter-pg` 穩定性問題
- Custom output path + driver adapter 的組合觸發 bug

### 技術決策記錄

1. **Middleware 檔名選擇**：使用 `src/middleware.ts` 而非 `proxy.ts`
   - Next.js 16 棄用 middleware 但仍支援
   - 棄用警告不影響功能
   - `proxy.ts` 會造成混淆

2. **SessionProvider 範圍**：包裹整個 `(admin)` route group
   - 在 `src/app/(admin)/layout.tsx` 層級
   - 覆蓋 `/login` 和 `/admin/*`
   - 避免重複包裹

3. **前台路由修正**：刪除 `src/app/page.tsx`
   - 最簡單直接的方式
   - 讓 `(public)/page.tsx` 自動生效

4. **Prisma 7 初始化**：強制使用 driver adapter
   - Custom output path + PostgreSQL 必須使用 adapter
   - `new PrismaClient({ adapter: new PrismaPg(...) })`

### 環境設定

**專案路徑：** `/home/openclaw/.openclaw/workspace-copilotcoder/novascribe`

**資料庫：**
- PostgreSQL 18
- 使用者/資料庫：`novascribe`/`novascribe`
- 密碼：`novascribe`

**Admin 帳號：**
- Email: `admin@novascribe.local`
- 密碼: `changeme123`

**Seed 資料：**
- 3 個分類（技術、生活、隨筆）
- 10 個標籤（JavaScript、TypeScript、React、Next.js 等）
- 3 篇文章（2 PUBLISHED、1 DRAFT）
- 0 評論

### OpenSpec Changes 狀態

```
openspec/changes/
├── fix-prisma-init/      ✅ 17/17 完成
├── fix-auth-setup/       ✅ 22/22 完成
└── fix-frontend-setup/   ⚠️  36/41 部分完成（動態路由阻塞）
```

### 下一步行動

**選項 A：建立新 change 修正動態路由**
- 修正所有動態路由頁面的 async params 使用
- 可能需要重新生成 Prisma Client 或調整查詢方式

**選項 B：降級依賴版本**
- Prisma 降至 6.x（避免 adapter 強制要求）
- 或 Next.js 降至 15.x（避免 async params）

**選項 C：接受現況歸檔**
- 核心功能已完成（首頁、列表頁、後台認證）
- 動態路由問題作為已知 issue
- 優先處理其他功能

### 關鍵學習

1. **Prisma 7 重大變更**：Custom output path 強制使用 driver adapter
2. **Next.js 16 Breaking Change**：Dynamic params 改為 Promise
3. **Service 層 import 錯誤**：Default import vs named import 會導致 500 錯誤
4. **介面一致性**：元件期望的欄位名稱必須與 service 回傳的一致（`postCount` vs `_count.posts`）

### 修正的檔案清單

**Prisma 相關：**
- `src/lib/prisma.ts` - PrismaPg adapter 初始化
- `prisma/seed-content.ts` - 初始資料 seed script

**認證相關：**
- `src/middleware.ts` - NextAuth withAuth 中介層
- `src/app/(admin)/layout.tsx` - SessionProvider 包裹

**前台相關：**
- `src/app/(public)/page.tsx` - 首頁文章列表
- `src/components/public/common/CategoryList.tsx` - postCount 修正
- `src/components/public/common/TagCloud.tsx` - postCount 修正
- `src/lib/services/comment.service.ts` - Named import
- `src/lib/services/public-category.service.ts` - Named import
- `src/lib/services/public-post.service.ts` - Named import
- `src/lib/services/public-tag.service.ts` - Named import

**配置相關：**
- `next.config.ts` - allowedDevOrigins
- `src/app/api/admin/comments/stats/route.ts` - CommentStatus enum

**已刪除：**
- `src/app/page.tsx` - 讓 (public)/page.tsx 生效
